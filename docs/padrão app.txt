Vou analisar a estrutura do projeto para entender como funciona a execu√ß√£o em homologa√ß√£o e produ√ß√£o. 

Read [](file:///c%3A/Fontes/produtos/src/Ecommerce.Servicos.Produtos.Api/appsettings.json#1-1), lines 1 to 50

Read [](file:///c%3A/Fontes/produtos/src/Ecommerce.Servicos.Produtos.Api/appsettings.Staging.json#1-1), lines 1 to 50

Read [](file:///c%3A/Fontes/produtos/src/Ecommerce.Servicos.Produtos.Api/appsettings.Development.json#1-1), lines 1 to 50

Read [](file:///c%3A/Fontes/produtos/src/Ecommerce.Servicos.Produtos.Api/Program.cs)

Read [](file:///c%3A/Fontes/produtos/src/Ecommerce.Servicos.Produtos.Api/Startup.cs)

Searched for files matching `**/Dockerfile`, no matches

Searched for files matching `**/*.yaml`, no matches

Searched for files matching `**/*.yml`, 1 match

Read [](file:///c%3A/Fontes/produtos/scripts)

Read [](file:///c%3A/Fontes/produtos/.gitlab-ci.yml#1-1), lines 1 to 200

Read [](file:///c%3A/Fontes/produtos/docs)

Read [](file:///c%3A/Fontes/produtos/README.md#1-1), lines 1 to 50

Read [](file:///c%3A/Fontes/produtos/.gitlab-ci.yml#200-200), lines 200 to 215

Searched for regex `ASPNETCORE_ENVIRONMENT|Environment` (`**/src/**/*.csproj`), no results

Read [](file:///c%3A/Fontes/produtos/src/Ecommerce.Servicos.Produtos.Api/Ecommerce.Servicos.Produtos.Api.csproj)

Searched for files matching `**/web.config`, no matches

Searched for regex `ASPNETCORE_ENVIRONMENT|IsDevelopment\(\)|IsStaging\(\)|IsProduction\(\)` (`**/src/**/*.cs`), 2 results

Read [](file:///c%3A/Fontes/produtos/src/Ecommerce.Servicos.Produtos.Robo/Factories/ConfigurationFactory.cs)

Perfeito! Analisei completamente a estrutura do projeto. Agora vou criar um documento passo a passo detalhado sobre como funciona a execu√ß√£o em homologa√ß√£o e produ√ß√£o.

## üìã Passo a Passo: Execu√ß√£o em Homologa√ß√£o e Produ√ß√£o

Baseado na an√°lise do projeto **Ecommerce.Servicos.Produtos**, aqui est√° o guia completo para implementar em outro projeto:

---

## üéØ **1. ESTRUTURA DE AMBIENTES**

O projeto utiliza 3 ambientes distintos, cada um com suas configura√ß√µes:

### **Ambientes:**
- **Development** (Desenvolvimento local)
- **Staging** (Homologa√ß√£o)
- **Production** (Produ√ß√£o)

---

## üìÅ **2. ARQUIVOS DE CONFIGURA√á√ÉO (appsettings)**

### **Criar 3 arquivos de configura√ß√£o:**

```
appsettings.json              ‚Üí Configura√ß√£o base (geralmente produ√ß√£o)
appsettings.Development.json  ‚Üí Configura√ß√£o de desenvolvimento
appsettings.Staging.json      ‚Üí Configura√ß√£o de homologa√ß√£o
```

### **Conte√∫do de cada arquivo:**

Cada arquivo deve ter configura√ß√µes espec√≠ficas do ambiente:

- **Connection Strings** (banco de dados de cada ambiente)
- **Endpoints de APIs externas** (URLs diferentes por ambiente)
- **Tokens de autentica√ß√£o** (credenciais por ambiente)
- **URLs de SSO/Autentica√ß√£o**
- **Configura√ß√µes de logging**

**Exemplo:**

```json
// appsettings.Staging.json
{
  "ConnectionStrings": {
    "HServices": "DATA SOURCE=servidor-homolog;..."
  },
  "Autenticacao": {
    "Endpoint": "https://hml-sso.exemplo.com.br/auth",
    "Scope": "meu-escopo"
  },
  "ApiExterna": {
    "Token": "token-homologacao",
    "Endpoint": "https://api-hml.exemplo.com/"
  }
}

// appsettings.json (Production)
{
  "ConnectionStrings": {
    "HServices": "DATA SOURCE=servidor-producao;..."
  },
  "Autenticacao": {
    "Endpoint": "https://sso.exemplo.com.br/auth",
    "Scope": "meu-escopo"
  },
  "ApiExterna": {
    "Token": "token-producao",
    "Endpoint": "https://api.exemplo.com/"
  }
}
```

---

## ‚öôÔ∏è **3. CONFIGURA√á√ÉO DO .CSPROJ**

No arquivo `.csproj` da API, garantir que os arquivos de configura√ß√£o sejam copiados:

```xml
<ItemGroup>
  <Content Update="appsettings.Development.json">
    <CopyToOutputDirectory>Always</CopyToOutputDirectory>
  </Content>
  <Content Update="appsettings.json">
    <CopyToOutputDirectory>Always</CopyToOutputDirectory>
  </Content>
  <Content Update="appsettings.Staging.json">
    <CopyToOutputDirectory>Always</CopyToOutputDirectory>
  </Content>
</ItemGroup>
```

---

## üîß **4. CONFIGURA√á√ÉO DO STARTUP.CS**

O Startup.cs detecta automaticamente o ambiente atrav√©s do `IWebHostEnvironment`:

```csharp
public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    // Comportamento diferente para produ√ß√£o
    if (env.IsProduction())
    {
        app.UseHsts();
    }
    else
    {
        app.UseDeveloperExceptionPage();
    }
    
    // Configura√ß√µes comuns
    app.UseAuthentication();
    app.UseRouting();
    // ...
}
```

**M√©todos dispon√≠veis:**
- `env.IsDevelopment()` - Verifica se √© Development
- `env.IsStaging()` - Verifica se √© Staging/Homologa√ß√£o
- `env.IsProduction()` - Verifica se √© Produ√ß√£o

---

## üåç **5. VARI√ÅVEL DE AMBIENTE (ASPNETCORE_ENVIRONMENT)**

O ASP.NET Core usa a vari√°vel de ambiente `ASPNETCORE_ENVIRONMENT` para determinar qual arquivo de configura√ß√£o carregar:

### **Como funciona:**

```
ASPNETCORE_ENVIRONMENT=Development ‚Üí Carrega appsettings.Development.json
ASPNETCORE_ENVIRONMENT=Staging     ‚Üí Carrega appsettings.Staging.json
ASPNETCORE_ENVIRONMENT=Production  ‚Üí Carrega appsettings.json
(vazio ou n√£o definido)            ‚Üí Carrega appsettings.json (padr√£o)
```

### **Exemplo de c√≥digo para projetos Console/Robo:**

```csharp
public class ConfigurationFactory
{
    private readonly string appSettingsFileName;

    public ConfigurationFactory()
    {
        var environment = Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT");

        appSettingsFileName = string.IsNullOrEmpty(environment)
            ? "appsettings.json" 
            : $"appsettings.{environment}.json";
    }

    public IConfiguration Generate()
    {
        return new ConfigurationBuilder()
          .AddJsonFile(appSettingsFileName, true, true)
          .Build();
    }
}
```

---

## üöÄ **6. PIPELINE CI/CD (GitLab CI)**

### **Estrutura do Pipeline:**

```yaml
stages:
  - build          # Compila√ß√£o
  - staging        # Deploy em homologa√ß√£o
  - production     # Deploy em produ√ß√£o
```

### **6.1. Stage BUILD (Compila√ß√£o)**

```yaml
build_api:
  stage: build
  tags:
    - integracao
  script:
    - "cd src/MeuProjeto.Api"
    - "dotnet build --source $NUGET_HERVAL_URL --source $NUGET_URL"
  only:
    changes:
      - src/**/*  # S√≥ executa se houver mudan√ßas no c√≥digo
```

### **6.2. Stage STAGING (Homologa√ß√£o - Autom√°tico)**

```yaml
staging_api:
  stage: staging
  tags:
    - integracao
  variables:
    project_name: "Api"
    remote_path: "MeuProjeto/Api"
  only:
    refs:
      - develop  # S√≥ executa na branch develop
    changes:
      - src/**/*
  
  before_script:
    # Instala ferramenta FTP
    - "apt-get update -qq && apt-get install -y -qq lftp"
    
    # Cria pasta de manuten√ß√£o e copia app_offline.htm
    - mkdir AppOff
    - lftp -u $FTP_USERNAME,$FTP_PASSWORD $FTP_HOST_STAGING 
        -e "mirror --verbose StaticDevel/manutencao AppOff; quit"
    
    # Envia app_offline.htm para servidor (coloca site em manuten√ß√£o)
    - lftp -u $FTP_USERNAME,$FTP_PASSWORD $FTP_HOST_STAGING 
        -e "mirror --verbose -R -p AppOff $remote_path; quit"

  script:
    # Publica aplica√ß√£o para Windows
    - "cd src/MeuProjeto.Api"
    - "dotnet publish -c Release -o bin/release/publish 
        --source $NUGET_HERVAL_URL 
        --source $NUGET_URL 
        --runtime win-x64 
        --self-contained"
    
    # Envia arquivos publicados para servidor via FTP
    - lftp -u $FTP_USERNAME,$FTP_PASSWORD $FTP_HOST_STAGING 
        -e "mirror -v -R -p bin/release/publish $remote_path; quit"

  after_script:
    # Remove app_offline.htm (retira site de manuten√ß√£o)
    - lftp -e "cd $remote_path && rm -f app_offline.htm" 
        -u $FTP_USERNAME,$FTP_PASSWORD $FTP_HOST_STAGING

  environment:
    name: staging
    url: https://hml-api.exemplo.com.br/meuprojeto
```

### **6.3. Stage PRODUCTION (Produ√ß√£o - Manual)**

```yaml
production_api:
  stage: production
  tags:
    - integracao
  variables:
    project_name: "Api"
    remote_path: "MeuProjeto/Api"
  when: manual  # IMPORTANTE: Requer aprova√ß√£o manual
  only:
    refs:
      - master  # S√≥ executa na branch master
    changes:
      - src/**/*
  
  before_script:
    # Mesmo processo de staging: manuten√ß√£o antes do deploy
    - "apt-get update -qq && apt-get install -y -qq lftp"
    - mkdir AppOff
    - lftp -u $FTP_USERNAME,$FTP_PASSWORD $FTP_HOST_PRODUCTION 
        -e "mirror --verbose -R -p AppOff $remote_path; quit"

  script:
    - "cd src/MeuProjeto.Api"
    - "dotnet publish -c Release -o bin/release/publish 
        --source $NUGET_HERVAL_URL 
        --source $NUGET_URL 
        --runtime win-x64 
        --self-contained"
    - lftp -u $FTP_USERNAME,$FTP_PASSWORD $FTP_HOST_PRODUCTION 
        -e "mirror -v -R -p bin/release/publish $remote_path; quit"

  after_script:
    - lftp -e "cd $remote_path && rm -f app_offline.htm" 
        -u $FTP_USERNAME,$FTP_PASSWORD $FTP_HOST_PRODUCTION

  environment:
    name: production
    url: https://api.exemplo.com.br/meuprojeto
```

---

## üéØ **7. FLUXO COMPLETO DE DEPLOY**

### **HOMOLOGA√á√ÉO (Staging):**

1. **Desenvolvedor** faz commit na branch `develop`
2. **GitLab CI** detecta mudan√ßas em `src/**/*`
3. **Stage BUILD** executa: compila√ß√£o do projeto
4. **Stage STAGING** executa automaticamente:
   - Coloca site em manuten√ß√£o (`app_offline.htm`)
   - Publica aplica√ß√£o com configura√ß√£o de Release
   - Envia arquivos via FTP para servidor de homologa√ß√£o
   - Remove arquivo de manuten√ß√£o
5. **Aplica√ß√£o dispon√≠vel** em: `https://hml-api.exemplo.com.br`

### **PRODU√á√ÉO (Production):**

1. **Desenvolvedor** faz merge para branch `master`
2. **GitLab CI** detecta mudan√ßas em `src/**/*`
3. **Stage BUILD** executa: compila√ß√£o do projeto
4. **Stage PRODUCTION** fica aguardando **aprova√ß√£o manual** ‚ö†Ô∏è
5. **Respons√°vel** aprova manualmente no GitLab
6. **Deploy executa**:
   - Coloca site em manuten√ß√£o
   - Publica aplica√ß√£o
   - Envia arquivos via FTP para servidor de produ√ß√£o
   - Remove arquivo de manuten√ß√£o
7. **Aplica√ß√£o dispon√≠vel** em: `https://api.exemplo.com.br`

---

## üìù **8. VARI√ÅVEIS DO GITLAB CI**

Configure as seguintes vari√°veis no GitLab (Settings ‚Üí CI/CD ‚Üí Variables):

```
NUGET_HERVAL_URL       - URL do NuGet privado
NUGET_URL              - URL do NuGet p√∫blico
FTP_USERNAME           - Usu√°rio FTP
FTP_PASSWORD           - Senha FTP (protegida)
FTP_HOST_STAGING       - Host FTP de homologa√ß√£o
FTP_HOST_PRODUCTION    - Host FTP de produ√ß√£o
```

---

## ‚úÖ **9. CHECKLIST DE IMPLEMENTA√á√ÉO**

Para implementar em outro projeto:

- [ ] Criar appsettings.Development.json com configs de desenvolvimento
- [ ] Criar appsettings.Staging.json com configs de homologa√ß√£o
- [ ] Criar/ajustar appsettings.json com configs de produ√ß√£o
- [ ] Configurar `.csproj` para copiar os appsettings
- [ ] Ajustar Startup.cs para comportamentos por ambiente
- [ ] Criar arquivo .gitlab-ci.yml na raiz do projeto
- [ ] Configurar stages: build, staging, production
- [ ] Configurar vari√°veis de ambiente no GitLab
- [ ] Definir branch `develop` para staging
- [ ] Definir branch `master` para production
- [ ] Testar deploy em staging primeiro
- [ ] Configurar aprova√ß√£o manual para production

---

## üîë **10. PONTOS IMPORTANTES**

1. **Arquivo app_offline.htm**: Coloca aplica√ß√£o ASP.NET em manuten√ß√£o durante deploy
2. **--self-contained**: Inclui o runtime .NET no pacote publicado
3. **--runtime win-x64**: Especifica que √© para Windows 64 bits
4. **when: manual**: Garante que produ√ß√£o s√≥ seja atualizada com aprova√ß√£o
5. **only.refs**: Controla quais branches disparam o deploy
6. **only.changes**: S√≥ executa se houver mudan√ßas no c√≥digo fonte

---

Esse √© o fluxo completo usado no projeto analisado! Voc√™ pode adaptar conforme sua infraestrutura (Docker, Kubernetes, Azure DevOps, etc.).